# =============================================================================
# Air Quality Monitor - ESPHome Configuration
# Controller: NodeMCU v3 (ESP8266)
# =============================================================================
#
# NodeMCU v3 핀아웃 (ESP8266):
# 
#   +-----+-----+----------+----------+
#   | Pin | GPIO| Function | 사용 용도  |
#   +-----+-----+----------+----------+
#   | D0  | 16  | GPIO     | CO2 TX   |
#   | D1  | 5   | GPIO/SCL | I2C SCL  |
#   | D2  | 4   | GPIO/SDA | I2C SDA  |
#   | D3  | 0   | GPIO     | TFT RST  |
#   | D4  | 2   | GPIO     | TFT DC   |
#   | D5  | 14  | GPIO/SCK | CO2 RX   |
#   | D6  | 12  | GPIO     | PMS RX   |
#   | D7  | 13  | GPIO/MOSI| PMS TX   |
#   | D8  | 15  | GPIO/CS  | TFT CS   |
#   | D9  | 3   | GPIO/RX  | RGB R    |
#   | D10 | 1   | GPIO/TX  | RGB G    |
#   | A0  | ADC | ADC      | 보정 버튼 |
#   +-----+-----+----------+----------+
#
# 센서 연결:
# - CO2/온습도 (SCD30): I2C (D1=SCL, D2=SDA) - CO₂, 온도, 습도 동시 측정
# - 미세먼지 (PMS7003): UART (D7=TX, D6=RX)  
# - VOC (SGP40): I2C (D1=SCL, D2=SDA)
# - 온습도 (SHT20): I2C (D1=SCL, D2=SDA) - 선택사항 (SCD30으로 대체 가능)
# - TFT LCD: SPI (D8=CS, D4=DC, D3=RST, D7=MOSI, D5=SCK)
# - RGB LED: PWM (D9=R, D10=G, D0=B)
# - 제어 출력: GPIO (D1=OUT1, D2=OUT2, D6=OUT3)
# - 보정 버튼: ADC (A0)
#
# 주의사항:
# - D3(GPIO0): 부팅시 LOW이면 플래시 모드 진입
# - D9(GPIO3), D10(GPIO1): 시리얼 통신과 공유 (부팅시 주의)
# - I2C와 제어 출력이 핀을 공유하므로 신중한 설계 필요
#
# ESPHome 센서 지원 상태:
# ✅ SCD30 (CO₂/온습도): 완벽 지원 - 'scd30' 플랫폼
# ✅ PMS7003 (미세먼지): 완벽 지원 - 'pmsx003' 플랫폼  
# ✅ SGP40 (VOC): 완벽 지원 - 'sgp40' 플랫폼
# ✅ SHT20 (온습도): HTU21D 호환 지원 - 'htu21d' 플랫폼 (선택사항)
# =============================================================================

esphome:
  name: air-quality-monitor
  friendly_name: "Air Quality Monitor"
  platform: ESP8266
  board: nodemcuv2

# WiFi 설정
wifi:
  ssid: "YOUR_WIFI_SSID"
  password: "YOUR_WIFI_PASSWORD"
  
  # WiFi 연결 실패시 호스트스팟 모드
  ap:
    ssid: "Air-Quality-Monitor"
    password: "12345678"

# 웹서버 활성화
web_server:
  port: 80

# Home Assistant API
api:
  encryption:
    key: "YOUR_API_KEY"

# OTA 업데이트
ota:
  password: "YOUR_OTA_PASSWORD"

# 로깅
logger:
  level: INFO

# I2C 버스 설정 (SCD30, SGP40, 온습도 센서용)
i2c:
  sda: D2  # GPIO4
  scl: D1  # GPIO5
  scan: true

# UART 설정 (미세먼지 센서용)
uart:
  # PMS7003 미세먼지 센서용 UART
  - id: uart_pms
    tx_pin: D7  # GPIO13  
    rx_pin: D6  # GPIO12
    baud_rate: 9600

# 센서 설정
sensor:
  # WiFi 신호 강도
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    
  # 업타임
  - platform: uptime
    name: "Uptime"
    
  # SHT20 온습도 센서 (HTU21D 호환) - 선택사항 (SCD30이 온습도도 제공)
  # - platform: htu21d
  #   temperature:
  #     name: "Temperature (SHT20)"
  #     id: temp_sensor_sht20
  #     unit_of_measurement: "°C"
  #     accuracy_decimals: 1
  #     filters:
  #       - filter_out: nan
  #   humidity:
  #     name: "Humidity (SHT20)" 
  #     id: humidity_sensor_sht20
  #     unit_of_measurement: "%"
  #     accuracy_decimals: 1
  #     filters:
  #       - filter_out: nan
  #   update_interval: 10s

  # SCD30 CO2/온습도 센서 (I2C)
  - platform: scd30
    co2:
      name: "CO2"
      id: co2_sensor
      accuracy_decimals: 0
      filters:
        - filter_out: nan
        - clamp:
            min_value: 400
            max_value: 40000
    temperature:
      name: "Temperature"
      id: temp_sensor
      accuracy_decimals: 1
      filters:
        - filter_out: nan
    humidity:
      name: "Humidity"
      id: humidity_sensor
      accuracy_decimals: 1
      filters:
        - filter_out: nan
    automatic_self_calibration: true
    ambient_pressure_compensation: 1013  # mBar (해당 지역 대기압으로 조정)
    altitude_compensation: 0  # 미터 (해당 지역 고도로 조정)
    temperature_offset: 0.0  # °C (온도 보정값)
    update_interval: 10s

  # PMS7003 미세먼지 센서  
  - platform: pmsx003
    type: PMSX003
    uart_id: uart_pms
    pm_1_0:
      name: "PM1.0"
      id: pm1_sensor
      unit_of_measurement: "μg/m³"
    pm_2_5:
      name: "PM2.5"
      id: pm25_sensor
      unit_of_measurement: "μg/m³"
    pm_10_0:
      name: "PM10"
      id: pm10_sensor
      unit_of_measurement: "μg/m³"
    update_interval: 10s

  # SGP40 VOC 센서 (I2C)
  - platform: sgp4x
    voc:
      name: "VOC Index"
      id: voc_sensor
      algorithm_tuning:
        index_offset: 100
        learning_time_offset_hours: 12
        learning_time_gain_hours: 12
        gating_max_duration_minutes: 180
        std_initial: 50
        gain_factor: 230
    compensation:
      temperature_source: temp_sensor
      humidity_source: humidity_sensor
    update_interval: 10s
    store_baseline: true

  # 공기질 종합 점수 (템플릿 센서) - 테스트용 주석처리
  # - platform: template
  #   name: "Air Quality Score"
  #   id: air_quality_score
  #   unit_of_measurement: "점"
  #   accuracy_decimals: 0
  #   lambda: |-
  #     int score = 0;
  #     
  #     // CO2 점수 (0-3)
  #     float co2_val = id(co2_sensor).state;
  #     if (co2_val > 2000) score += 3;
  #     else if (co2_val > 1200) score += 2;
  #     else if (co2_val > 800) score += 1;
  #     
  #     // PM2.5 점수 (0-3)
  #     float pm25_val = id(pm25_sensor).state;
  #     if (pm25_val > 75) score += 3;
  #     else if (pm25_val > 35) score += 2;
  #     else if (pm25_val > 15) score += 1;
  #     
  #     return score;
  #   update_interval: 5s

# 바이너리 센서 (버튼)
binary_sensor:
  # CO2 보정 버튼 (SCD30은 자동 보정 기능이 있어 수동 보정이 덜 필요함)
  - platform: analog_threshold
    sensor_id: calibration_btn_analog
    name: "CO2 Calibration Button"
    id: calibration_button
    threshold: 512
    on_press:
      - delay: 3s
      - if:
          condition:
            binary_sensor.is_on: calibration_button
          then:
            - logger.log: "SCD30 강제 보정 실행 (400ppm)"
            # SCD30 강제 보정 (Forced Recalibration)
            - lambda: |-
                id(co2_sensor).set_forced_recalibration_factor(400);

# 아날로그 센서 (보정 버튼용)
sensor:
  - platform: adc
    pin: A0
    name: "Calibration Button Analog"
    id: calibration_btn_analog
    internal: true
    update_interval: 0.1s

# RGB LED 설정
light:
  - platform: rgb
    name: "Air Quality LED"
    id: rgb_led
    red: pwm_r
    green: pwm_g
    blue: pwm_b
    restore_mode: ALWAYS_OFF
    
# PWM 출력 (RGB LED)
output:
  - platform: esp8266_pwm
    pin: GPIO3  # D9 - Red
    frequency: 1000 Hz
    id: pwm_r
    
  - platform: esp8266_pwm
    pin: GPIO1  # D10 - Green  
    frequency: 1000 Hz
    id: pwm_g
    
  - platform: esp8266_pwm
    pin: GPIO16  # D0 - Blue
    frequency: 1000 Hz
    id: pwm_b

  # 하드웨어 제어 출력
  - platform: gpio
    pin: D1  # GPIO5 - 환기팬
    id: out1_ventilation
    
  - platform: gpio
    pin: D2  # GPIO4 - 공기청정기
    id: out2_purifier
    
  - platform: gpio
    pin: D6  # GPIO12 - 가습기/제습기
    id: out3_humidifier

# 스위치 (하드웨어 제어)
switch:
  - platform: output
    name: "Ventilation Fan"
    id: ventilation_switch
    output: out1_ventilation
    
  - platform: output
    name: "Air Purifier"
    id: purifier_switch
    output: out2_purifier
    
  - platform: output
    name: "Humidifier"
    id: humidifier_switch
    output: out3_humidifier

  # 자동 제어 모드 스위치
  - platform: template
    name: "Auto Control Mode"
    id: auto_control_mode
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON

# 디스플레이 설정 (TFT LCD)
spi:
  clk_pin: D5   # GPIO14 - SCK
  mosi_pin: D7  # GPIO13 - MOSI

display:
  - platform: st7735
    model: REDTAB
    cs_pin: D8     # GPIO15
    dc_pin: D4     # GPIO2  
    reset_pin: D3  # GPIO0
    rotation: 0
    lambda: |-
      // 배경색 설정
      it.fill(COLOR_BLACK);
      
      // 제목
      it.print(0, 5, id(font_title), COLOR_WHITE, "Air Quality");
      
      // CO2 표시
      if (id(co2_sensor).has_state()) {
        it.printf(0, 25, id(font_sensor), COLOR_WHITE, "CO2: %.0f ppm", id(co2_sensor).state);
      } else {
        it.print(0, 25, id(font_sensor), COLOR_WHITE, "CO2: ---");
      }
      
      // PM2.5 표시
      if (id(pm25_sensor).has_state()) {
        it.printf(0, 40, id(font_sensor), COLOR_WHITE, "PM2.5: %.0f ug/m3", id(pm25_sensor).state);
      } else {
        it.print(0, 40, id(font_sensor), COLOR_WHITE, "PM2.5: ---");
      }
      
      // 온도 표시
      if (id(temp_sensor).has_state()) {
        it.printf(0, 55, id(font_sensor), COLOR_WHITE, "TEMP: %.1f C", id(temp_sensor).state);
      } else {
        it.print(0, 55, id(font_sensor), COLOR_WHITE, "TEMP: ---");
      }
      
      // 습도 표시
      if (id(humidity_sensor).has_state()) {
        it.printf(0, 70, id(font_sensor), COLOR_WHITE, "HUM: %.1f %%", id(humidity_sensor).state);
      } else {
        it.print(0, 70, id(font_sensor), COLOR_WHITE, "HUM: ---");
      }
      
      // 공기질 점수 표시
      if (id(air_quality_score).has_state()) {
        it.printf(0, 85, id(font_sensor), COLOR_WHITE, "AQS: %.0f", id(air_quality_score).state);
      }

# 폰트 설정
font:
  - file: "gfonts://Roboto"
    id: font_title
    size: 12
  - file: "gfonts://Roboto"  
    id: font_sensor
    size: 10

# 자동화 (공기질 기반 제어)
interval:
  - interval: 30s
    then:
      - if:
          condition:
            switch.is_on: auto_control_mode
          then:
            # CO2 기반 환기팬 제어
            - if:
                condition:
                  lambda: 'return id(co2_sensor).state > 2000;'
                then:
                  - switch.turn_on: ventilation_switch
                else:
                  - if:
                      condition:
                        lambda: 'return id(co2_sensor).state < 800;'
                      then:
                        - switch.turn_off: ventilation_switch
            
            # PM2.5 기반 공기청정기 제어  
            - if:
                condition:
                  lambda: 'return id(pm25_sensor).state > 75;'
                then:
                  - switch.turn_on: purifier_switch
                else:
                  - if:
                      condition:
                        lambda: 'return id(pm25_sensor).state < 15;'
                      then:
                        - switch.turn_off: purifier_switch
            
            # 습도 기반 가습기 제어
            - if:
                condition:
                  lambda: 'return id(humidity_sensor).state < 30 || id(humidity_sensor).state > 70;'
                then:
                  - switch.turn_on: humidifier_switch
                else:
                  - switch.turn_off: humidifier_switch
            
            # RGB LED 색상 제어
            - if:
                condition:
                  lambda: 'return id(air_quality_score).state <= 1;'
                then:
                  - light.turn_on:
                      id: rgb_led
                      red: 0%
                      green: 100%
                      blue: 0%
                else:
                  - if:
                      condition:
                        lambda: 'return id(air_quality_score).state <= 3;'
                      then:
                        - light.turn_on:
                            id: rgb_led
                            red: 100%
                            green: 100%
                            blue: 0%
                      else:
                        - if:
                            condition:
                              lambda: 'return id(air_quality_score).state <= 4;'
                            then:
                              - light.turn_on:
                                  id: rgb_led
                                  red: 100%
                                  green: 65%
                                  blue: 0%
                            else:
                              - light.turn_on:
                                  id: rgb_led
                                  red: 100%
                                  green: 0%
                                  blue: 0%